from typing import Dict
from services.cache.cache_manager import CacheManager

def cisa_kev_enrich_vulnerability(cve: str, cache_manager: CacheManager) -> Dict:
    cache_manager.wait_for_data('cisa_kev')

    data = cache_manager.get_data('cisa_kev')
    
    if not data:
        print("[!] CISA KEV data is unavailable.")
        return {}

    try:
        kev_vulnerabilities = data.get("vulnerabilities", [])
        for item in kev_vulnerabilities:
            if item.get("cveID") == cve:
                enriched_data = {
                    "cisa_description": item.get("shortDescription"),
                    "cisa_dateAdded": item.get("dateAdded"),
                    "cisa_requiredAction": item.get("requiredAction"),
                    "cisa_dueDate": item.get("dueDate"),
                    "cisa_knownRansomwareCampaignUse": item.get("knownRansomwareCampaignUse"),
                    "cisa_notes": item.get("notes"),
                    "cisa_cwes": item.get("cwes"),
                    "cisa_vulnerabilityName": item.get("vulnerabilityName"),
                    "cisa_vendorProject": item.get("vendorProject"),
                    "cisa_product": item.get("product")
                }
                return enriched_data
    except Exception as e:
        print(f"[!] Error processing CISA KEV data for CVE {cve}: {e}")

    return {}
